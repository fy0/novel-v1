# 剧情脚本测试1

测试性的剧情脚本语言

注意，只是v1草案，语法还可能修改

设计思路:
- 以写作为主，为文案人员设计，只有极少的特殊语法且很难误触
- 剧情文本由被称为“节点”的文本段构成，能够轻易转换为剧情流程图，再从流程图转换为原文
- 易于嵌入各种引擎(我知道没有go写的引擎，但是这是一个设计原型)

## 语法介绍

先说明一下，这个剧情脚本的第一版设计，是不带任何逻辑语法的。

剧情脚本主要以文本对话为主，你可以选择你喜欢的脚本引擎嵌入。

测试用例中嵌入的是 [DiceScript](https://github.com/sealdice/dicescript)，这是一个简易脚本引擎并带有常见的骰点语法。


### 基础写法

```
:第一段
这是第一段文本

:第二段
这是第二段文本

想写几行写几行
   任何格式都会原样输出

:第三段
结束
```


执行结果:
```
这是第一段文本

这是第二段文本
想写几行写几行
   任何格式都会原样输出
结束
```


整个文本除了":"开头的部分，都会被顺序输出。

### 关于分段

目前只有两个特殊语法，第一个是":"开头的行，完整规则如下：

```
:分段标题[条件][下一分段]
```

注: 为了将对原始文本影响减到最小，冒号必须另起一行，前面不能空格

分段标题、条件、下一分段三项均可省略，举例说明：

#### 首先来看全省略，两个分段，不做命名
```
:
这是开始

:
这是结束
```

执行结果:
```
这是开始
这是结束
```

#### 省略名字和条件

```cmd
:[][结束]
这是开始，会直接跳到结束

:
这段跳过

:结束
这是结束
```

执行结果:
```
这是开始，会直接跳到结束
这是结束
```

#### 满足条件时经过

这里有一个新的语法，暂时只需要知道这是为 x 取了一个 1-10 的随机值

```
:
有一半可能跳过第二段
@{ x = d10 }!

:[x > 5]
第二段

:结束
这是结束
```

执行结果:
```
有一半可能跳过第二段
第二段
这是结束
```


#### 满足条件时经过 - 加强版

假设一个事件有几种分支选项，我们希望对每种可能进行判断，可以这么做：

```
:
三个分支
@{ x = d3 }!

:[x == 1][结束]
分支A

:[x == 2][结束]
分支B

:[x == 3][结束]
分支C

:结束
这是结束
```

执行结果:
```
三个分支
分支C
这是结束
```

说明: 如果把分支选项转成图像，这里会出现起点到A、B、C，然后这三个点分别连到终点。

### 关于代码嵌入

关于在文本中嵌入代码块，有两个语法：

```
@函数名(参数1, 参数2)
```

参数可以是标识符、字符串、数字、小数。参数可以是0个和任意多个

几个可用的预设函数：

打印一段话，和普通剧情文本效果相同
```
@say('这是一段话')
```

提供三个分支选项供用户选择：
```
@select('选项A', '选项B', '选项C')
```

要求用户输入一段文本：
```
@input('请输入文本:')
```

第二个语法用于长段嵌入：
```
@{
// 这里可以是任意的代码块
}!
```

#### 最后还是举个例子

```
:启动
@select('选项A', '选项B', '选项C')

:[]
```

## 关于接入

如果你想接入他的话，需要实现这三个接口：

```go
type StoryLoader struct {
    InvokeCallback    func(sl *StoryLoader, name string, params []string) (bool, error)
    CodeCallback      func(sl *StoryLoader, expr string) (any, error)
    ConditionCallback func(sl *StoryLoader, expr string) (bool, error)
}
```

第一个对应 `@xxxx()` 语法

第二个对应 `@{ }!` 语法

第三个是分段中跳转语句的解析

特别注意的是，InvokeCallback中**需要实现**这四个函数：
```
@say('这是一段话')
@sayRaw(这是一段话)
@select('选项A', '选项B', '选项C')
@input('请输入文本:')
```

推荐实现的是 `@use('另一个脚本文件.ns')`

文本中的所有普通文本，会被编译成 @sayRaw 的调用

web版用的是gopherjs，编译指令：
```
gopherjs.exe build .\jsport\ -o jsport/x.js
```
