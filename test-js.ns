:开始
你是一名勇者。
经过艰难的抉择，刻苦的磨炼，以及不懈的努力。
你来到了这里。
只要打倒魔王，一切就结束了！

会赢吗？
会赢的。
来战斗吧！

注: 伤害公式 = 攻击/2 + d(攻击)

:init
@{
    vars.d = (n) => parseInt(Math.random() * n + 1);
    vars.me = { 'hp': 30 + d(30), 'spd': 5 + d(5), 'atk': 5 + d(5), 'name': '玩家' };
}

:遇怪循环[me.atk>50][打boss]
时机成熟了，去打BOSS!

:遇怪

战！
@{
    vars.e = { 'hp': d(40), 'spd': d(me.spd)+d(10), 'atk': d(me.atk)+d(10), 'name': ['哥布林', '软泥怪', '骷髅兵'][d(3)-1] };
}
遇到怪物 {e.name}


:打怪循环

玩家属性 生命{me.hp} 速度{me.spd} 攻击 {me.atk}
怪物属性 生命{e.hp} 速度{e.spd} 攻击 {e.atk} <{e.name}>
@{ await select(`战斗!`, '逃跑', '不玩了！') }

:[val == 1]

@{
let a, b;
// a为先攻，b为后手
if (me.spd >= e.spd) {
    a = me;
    b = e;
} else {
    a = e;
    b = me;
}

let _dmg1 = a.atk / 2 + d(a.atk); // 攻方攻击力
let _dmg2 = b.atk / 2 + d(b.atk); // 守方攻击力

let save_bhp = b.hp;
let save_ahp = a.hp;

b.hp = b.hp - _dmg1;
if (b.hp > 0) {
    a.hp = a.hp - _dmg2;
}

var text = `先攻: ${a.name} 造成伤害: ${a.atk/2}+d${a.atk}=${_dmg1}
${b.name} 生命值: ${save_bhp} -> ${b.hp}`;

let isEnd = false;

if (b.hp <= 0) {
    isEnd = true;
    text = text + `\n${b.name} 挂了!`;
} else {
    text = text + `\n后手: ${b.name} 造成伤害: ${b.atk/2}+d${b.atk}=${_dmg2}
${a.name} 生命值: ${save_ahp} -> ${a.hp}`;

    if (a.hp <= 0) {
        text = text + `\n${a.name} 挂了!`;
        isEnd = true;
        // 互换 a b
        c = a; a = b; b = c;
    }
}

if (isEnd) {
    // 之后 a 代表胜者，b代表败者
    if (a.name == '玩家') {
        let hpPlus = d(15);
        let atkPlus = d(b.atk);
        text = text + `\n\n玩家胜利！hp 恢复 d15=${hpPlus} \n攻击力增加 d${b.atk} = ${atkPlus}`;
        a.atk = a.atk + atkPlus;
        a.hp = a.hp + hpPlus;
    } else {
        text = text + `玩家阵亡!`;
    }
}
vars.text = text;
}
{text}

:[val == 1 && me.hp < 0][end]
啊，我死了

:[val == 1 && e.hp > 0][打怪循环]
:[val == 1 && e.hp <= 0][遇怪循环]

:[val == 2][遇怪循环]
先跑路了，换一只怪！

:[val == 3][回去了]


:打boss

这是boss，但是意外的非常弱。
你看了他一眼，把boss瞪死了。


:结束[][end]

这是一个对于剧情脚本的测试demo
并未经过认真编写，
不过还是感谢游玩。

右上角可以看到源码。
同时还在持续的修改中。
查看页面源码可以看到是怎样和js绑定的，这里打印文本之类其实可以用异步函数，但是较早的时候写于同步版本，就没有修改。实际可以更简洁的。

:回去了
你感到无聊，走了。

:end
完

@{
// 其实我不太觉得这是一个好例子
// 应该说是比较差的例子了
// 因为里面塞了一个简易战斗，这其实不应该是剧情脚本引擎应该解决的问题
// 战斗的处理应该在外面的战斗系统来进行，剧情展示中即使有，也只做简单的调用
// 后面再搞别的例子吧
}
